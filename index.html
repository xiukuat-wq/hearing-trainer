<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®­å¬å™¨ | è·Ÿè¯»æŒ‘æˆ˜</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --dark: #2d3436;
            --light: #f8f9fa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 30px; box-shadow: 0 30px 60px rgba(0, 0, 0, 0.25); width: 100%; max-width: 1100px; padding: 40px; margin: 20px; }
        
        .header { text-align: center; margin-bottom: 40px; }
        h1 { color: var(--dark); font-size: 2.8em; margin-bottom: 10px; background: linear-gradient(90deg, var(--primary), #9d4edd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .main-area { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        @media (max-width: 900px) { .main-area { grid-template-columns: 1fr; } }
        
        .panel { background: var(--light); border-radius: 25px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .panel-title { font-size: 1.4em; color: var(--primary); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid var(--primary); display: flex; align-items: center; gap: 12px; }
        
        /* å·¦ä¾§è¯æ±‡é¢æ¿ */
        #customWordList { width: 100%; height: 320px; padding: 25px; border: 3px solid #a29bfe; border-radius: 20px; font-size: 18px; line-height: 1.8; resize: vertical; background: #f9f9ff; margin-bottom: 20px; transition: border 0.3s; }
        #customWordList:focus { border-color: var(--primary); outline: none; }
        .vocab-stats { display: flex; justify-content: space-between; color: #636e72; font-size: 1.1em; }
        .vocab-stats span { color: var(--primary); font-weight: bold; }
        
        /* å³ä¾§è®¾ç½®é¢æ¿ */
        .settings-group { background: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; border: 2px solid #dfe6e9; }
        .setting-row { display: flex; flex-wrap: wrap; gap: 25px; margin-bottom: 20px; }
        .setting-item { flex: 1; min-width: 180px; }
        .setting-item label { display: block; font-weight: bold; color: var(--dark); margin-bottom: 10px; font-size: 1.1em; }
        .setting-item input, .setting-item select { width: 100%; padding: 15px; border: 3px solid #dfe6e9; border-radius: 15px; font-size: 16px; transition: all 0.3s; }
        .setting-item select:focus, .setting-item input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        
        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-toggle { display: flex; background: #e9ecef; border-radius: 15px; padding: 5px; margin-bottom: 25px; }
        .mode-btn { flex: 1; padding: 18px; text-align: center; border-radius: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .mode-btn.active { background: white; border-color: var(--primary); color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* éšæœºå‡ºé¢˜æ ·å¼ */
        .random-switch { display: flex; align-items: center; justify-content: space-between; background: white; padding: 20px; border-radius: 20px; border: 2px solid #dfe6e9; margin-bottom: 25px; }
        .random-label { display: flex; align-items: center; gap: 12px; font-weight: bold; color: var(--dark); font-size: 1.1em; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* éº¦å…‹é£æƒé™è¯´æ˜æ¡† */
        .permission-guide { 
            background: linear-gradient(135deg, #fff9e6, #ffeaa7); 
            border-left: 5px solid #ffd166; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            display: none;
            position: absolute;
            left: -320px;
            width: 280px;
            z-index: 10;
        }
        .permission-guide.show { display: block; }
        .permission-guide h4 { color: #e17055; margin-bottom: 10px; }
        
        /* è®­ç»ƒæ˜¾ç¤ºåŒºå®¹å™¨ */
        .train-container { 
            position: relative; 
            display: flex; 
            align-items: flex-start; 
            gap: 20px;
            margin: 25px 0; 
        }
        
        /* è®­ç»ƒæ˜¾ç¤ºåŒº */
        .train-display { 
            background: white; 
            border-radius: 25px; 
            padding: 40px 30px; 
            text-align: center; 
            border: 4px solid #dfe6e9; 
            transition: all 0.4s; 
            min-height: 320px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            flex: 1;
        }
        .train-display.listening { border-color: var(--primary); }
        .train-display.correct { border-color: var(--success); }
        .train-display.wrong { border-color: var(--danger); }
        
        #trainPhase { font-size: 1.8em; color: var(--dark); font-weight: bold; margin-bottom: 20px; min-height: 60px; }
        #answerWord { font-size: 3.2em; color: var(--dark); font-weight: bold; margin: 15px 0; min-height: 80px; }
        #feedbackText { font-size: 1.6em; font-weight: bold; margin: 20px 0; min-height: 50px; }
        .feedback-correct { color: var(--success); }
        .feedback-wrong { color: var(--danger); }
        
        /* å½“å‰æ¨¡å¼æ˜¾ç¤º */
        .current-mode { 
            font-size: 1.4em; 
            font-weight: bold; 
            margin-bottom: 25px; 
            color: var(--dark);
            text-align: center;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area { width: 100%; margin: 25px 0; }
        #textInput { width: 100%; padding: 25px; font-size: 1.8em; text-align: center; border: 4px solid var(--primary); border-radius: 20px; outline: none; display: none; }
        #textInput.show { display: block; }
        
        /* éº¦å…‹é£çŠ¶æ€ */
        .mic-status { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 25px 0; }
        .mic-icon { font-size: 3em; transition: all 0.3s; }
        .mic-icon.listening { color: var(--primary); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        #micStatusText { font-size: 1.3em; color: #636e72; font-weight: bold; }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
        button { padding: 20px 25px; border: none; border-radius: 16px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 12px; }
        #startBtn { background: linear-gradient(135deg, var(--success), #05a078); color: white; }
        #stopBtn { background: linear-gradient(135deg, var(--danger), #d63031); color: white; }
        #pauseBtn { background: linear-gradient(135deg, #4361ee, #3a56d4); color: white; }
        #saveBtn { background: linear-gradient(135deg, #9d4edd, #7b2cbf); color: white; }
        button:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        button:disabled { background: #b2bec3 !important; cursor: not-allowed; transform: none; opacity: 0.6; }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-bar { display: flex; justify-content: space-around; background: #f1f2f6; padding: 25px; border-radius: 20px; margin-top: 30px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 2.2em; color: var(--primary); font-weight: bold; display: block; }
        .stat-label { color: #636e72; font-size: 0.95em; margin-top: 8px; }
        
        /* æç¤ºä¿¡æ¯ */
        .tip-box { background: #fff9e6; border-left: 5px solid var(--warning); padding: 25px; border-radius: 15px; margin-top: 35px; }
        .tip-title { font-weight: bold; color: #e17055; margin-bottom: 15px; font-size: 1.2em; }
        
        /* éº¦å…‹é£æƒé™è¯´æ˜æ¡†ï¼ˆåœ¨é¡µé¢åº•éƒ¨ï¼‰ */
        .permission-info-box { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            border-left: 5px solid #2196f3; 
            padding: 25px; 
            border-radius: 15px; 
            margin-top: 25px;
            display: none;
        }
        .permission-info-box.show { display: block; }
        .permission-info-title { font-weight: bold; color: #1565c0; margin-bottom: 15px; font-size: 1.2em; }
        
        /* ç½‘ç«™æ ‡è¯† */
        .site-badge { text-align: center; margin-top: 30px; color: #636e72; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ è®­å¬å™¨</h1>
        </div>
        
        <div class="main-area">
            <!-- å·¦ä¾§ï¼šè¯æ±‡ç®¡ç†åŒº -->
            <div class="panel">
                <div class="panel-title">ğŸ“ æ‚¨çš„ä¸“å±è¯åº“</div>
                <textarea id="customWordList" placeholder="è¯·åœ¨æ­¤å½•å…¥æ‚¨éœ€è¦è®­ç»ƒçš„è¯æ±‡æˆ–çŸ­å¥ï¼Œæ¯è¡Œä¸€ä¸ªã€‚

ä¾‹å¦‚ï¼š
äººå·¥æ™ºèƒ½
ç¥ç»ç½‘ç»œ
æœºå™¨å­¦ä¹ 
é¡¹ç›®ç®¡ç†
å›¢é˜Ÿåä½œ
å­£åº¦æ±‡æŠ¥
å¸‚åœºåˆ†æ
...">äººå·¥æ™ºèƒ½
ç¥ç»ç½‘ç»œ
æœºå™¨å­¦ä¹ 
æ·±åº¦å­¦ä¹ 
ç®—æ³•ä¼˜åŒ–
æ•°æ®å¤„ç†</textarea>
                <div class="vocab-stats">
                    <div>è¯æ±‡æ•°: <span id="wordCountDisplay">6</span> ä¸ª</div>
                    <div>å»ºè®®æ¯æ¬¡è®­ç»ƒ 5-20 ä¸ªè¯</div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šè®­ç»ƒæ§åˆ¶åŒº -->
            <div class="panel">
                <div class="panel-title">âš™ï¸ è®­ç»ƒè®¾ç½®</div>
                
                <div class="settings-group">
                    <!-- æ¨¡å¼åˆ‡æ¢ -->
                    <div class="mode-toggle">
                        <div class="mode-btn active" data-mode="mic">
                            <span class="mode-icon">ğŸ¤</span>
                            <span>éº¦å…‹é£è·Ÿè¯»</span>
                        </div>
                        <div class="mode-btn" data-mode="text">
                            <span class="mode-icon">âŒ¨ï¸</span>
                            <span>æ‰“å­—è¾“å…¥</span>
                        </div>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-item">
                            <label>ğŸ”¢ è®­ç»ƒæ•°é‡ï¼š</label>
                            <input type="number" id="trainCount" value="6" min="1" max="30">
                        </div>
                        <div class="setting-item">
                            <label>ğŸ”Š æœ—è¯»è¯­é€Ÿï¼š</label>
                            <select id="speedRate">
                                <option value="0.7">å¾ˆæ…¢ (0.7x)</option>
                                <option value="0.8" selected>ç¨æ…¢ (0.8x)</option>
                                <option value="0.9">ä¸­é€Ÿ (0.9x)</option>
                                <option value="1.0">æ ‡å‡† (1.0x)</option>
                                <option value="1.1">ç¨å¿« (1.1x)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- éšæœºå‡ºé¢˜å¼€å…³ -->
                <div class="random-switch">
                    <div class="random-label">
                        <span class="random-icon">ğŸ”„</span>
                        <span>éšæœºå‡ºé¢˜</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="randomOrder" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- å½“å‰æ¨¡å¼æ˜¾ç¤º -->
                <div class="current-mode" id="currentModeDisplay">éº¦å…‹é£è·Ÿè¯»æ¨¡å¼</div>
                
                <!-- è®­ç»ƒæ˜¾ç¤ºåŒºå®¹å™¨ -->
                <div class="train-container">
                    <!-- éº¦å…‹é£æƒé™è¯´æ˜æ¡†ï¼ˆå·¦ä¾§ï¼‰ -->
                    <div class="permission-guide" id="permissionGuide">
                        <h4>ğŸ¤ éº¦å…‹é£æƒé™è¯´æ˜</h4>
                        <p>"è·Ÿè¯»æ¨¡å¼"éœ€è¦éº¦å…‹é£æƒé™ã€‚å½“æ‚¨ç¬¬ä¸€æ¬¡ç‚¹å‡»"å¼€å§‹æŒ‘æˆ˜"æ—¶ï¼Œæµè§ˆå™¨ä¼šè¯¢é—®æ˜¯å¦å…è®¸ä½¿ç”¨éº¦å…‹é£ï¼Œè¯·ç‚¹å‡»<strong>"å…è®¸"</strong>ã€‚</p>
                        <p><em>æç¤ºï¼šæƒé™åªéœ€æˆäºˆä¸€æ¬¡ï¼Œä»¥åè®¿é—®æœ¬ç½‘ç«™å°†è‡ªåŠ¨è®°ä½ã€‚</em></p>
                    </div>
                    
                    <!-- è®­ç»ƒæ ¸å¿ƒæ˜¾ç¤ºåŒº -->
                    <div class="train-display" id="trainDisplay">
                        <div id="trainPhase">å‡†å¤‡å¼€å§‹è®­ç»ƒ...</div>
                        <div id="answerWord"></div>
                        <div id="feedbackText"></div>
                        
                        <!-- æ‰“å­—è¾“å…¥æ¡† -->
                        <div class="input-area">
                            <input type="text" id="textInput" placeholder="è¯·è¾“å…¥æ‚¨å¬åˆ°çš„è¯" autocomplete="off">
                        </div>
                        
                        <!-- éº¦å…‹é£çŠ¶æ€ -->
                        <div class="mic-status">
                            <div id="micStatusText">éº¦å…‹é£è·Ÿè¯»æ¨¡å¼</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="control-buttons">
                    <button id="startBtn">â–¶ï¸ å¼€å§‹æŒ‘æˆ˜</button>
                    <button id="stopBtn" disabled>â¹ï¸ åœæ­¢æŒ‘æˆ˜</button>
                    <button id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
                    <button id="saveBtn">ğŸ’¾ ä¿å­˜è¯åº“</button>
                </div>
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-value" id="totalWordsStat">0</span>
                        <span class="stat-label">æ€»é¢˜æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="correctWordsStat">0</span>
                        <span class="stat-label">æ­£ç¡®</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="wrongWordsStat">0</span>
                        <span class="stat-label">éœ€å¤ä¹ </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tip-box">
            <div class="tip-title">ğŸ’¡ ä½¿ç”¨æŒ‡å—ï¼š</div>
            <p>1. <strong>é€‰æ‹©æ¨¡å¼</strong>ï¼šä¸Šæ–¹çš„"éº¦å…‹é£è·Ÿè¯»"æˆ–"æ‰“å­—è¾“å…¥"æŒ‰é’®å¯éšæ—¶åˆ‡æ¢ã€‚</p>
            <p>2. <strong>å¼€å§‹æŒ‘æˆ˜</strong>ï¼šç³»ç»Ÿæœ—è¯»è¯æ±‡ï¼ˆä¸æ˜¾ç¤ºæ–‡å­—ï¼‰ï¼Œæ ¹æ®æ¨¡å¼è¿›è¡Œè·Ÿè¯»æˆ–æ‰“å­—è¾“å…¥ã€‚</p>
            <p>3. <strong>æš‚åœåŠŸèƒ½</strong>ï¼šç‚¹å‡»"æš‚åœ"å¯æš‚åœè®­ç»ƒï¼Œç‚¹å‡»"ç»§ç»­"å¯æ¢å¤è®­ç»ƒã€‚</p>
            <p>4. <strong>å³æ—¶åé¦ˆ</strong>ï¼šç³»ç»Ÿç«‹å³åˆ¤æ–­å¯¹é”™å¹¶æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆã€‚</p>
            <p>5. <strong>ç½‘ç«™ä¼˜åŠ¿</strong>ï¼šé€šè¿‡HTTPSè®¿é—®ï¼Œéº¦å…‹é£æƒé™æ›´ç¨³å®šï¼Œæ•°æ®è‡ªåŠ¨ä¿å­˜ã€‚</p>
        </div>
        
        <!-- éº¦å…‹é£æƒé™è¯´æ˜æ¡†ï¼ˆåº•éƒ¨ï¼‰ -->
        <div class="permission-info-box" id="permissionInfoBox">
            <div class="permission-info-title">ğŸ¤ éº¦å…‹é£æƒé™è¯´æ˜</div>
            <p><strong>æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨é€‰æ‹©"éº¦å…‹é£è·Ÿè¯»"æ¨¡å¼ï¼Œç¬¬ä¸€æ¬¡ç‚¹å‡»"å¼€å§‹æŒ‘æˆ˜"æ—¶ï¼Œæµè§ˆå™¨ä¼šå¼¹å‡ºæƒé™è¯·æ±‚çª—å£ã€‚</p>
            <p>è¯·ç‚¹å‡»<strong>"å…è®¸"</strong>ä»¥ä½¿ç”¨éº¦å…‹é£åŠŸèƒ½ã€‚æƒé™åªéœ€æˆäºˆä¸€æ¬¡ï¼Œæµè§ˆå™¨ä¼šè®°ä½æ‚¨çš„é€‰æ‹©ã€‚</p>
            <p>å¦‚æœè¯¯ç‚¹äº†"æ‹’ç»"ï¼Œè¯·åœ¨æµè§ˆå™¨åœ°å€æ å·¦ä¾§ç‚¹å‡»"ğŸ”’"å›¾æ ‡æˆ–"ğŸŒ"å›¾æ ‡ï¼Œæ‰‹åŠ¨å¼€å¯éº¦å…‹é£æƒé™ã€‚</p>
        </div>
        
        <div class="site-badge">
            è®­å¬å™¨ Â· GitHub Pageséƒ¨ç½²ç‰ˆ | è®¾è®¡ï¼šä¸DeepSeekå…±åˆ›
        </div>
    </div>

    <script>
        // ==================== æ ¸å¿ƒå˜é‡ ====================
        const customWordListTextarea = document.getElementById('customWordList');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const saveBtn = document.getElementById('saveBtn');
        const trainCountInput = document.getElementById('trainCount');
        const speedRateSelect = document.getElementById('speedRate');
        const randomOrderCheckbox = document.getElementById('randomOrder');
        const permissionGuide = document.getElementById('permissionGuide');
        const permissionInfoBox = document.getElementById('permissionInfoBox');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const currentModeDisplay = document.getElementById('currentModeDisplay');
        
        // è®­ç»ƒæ˜¾ç¤ºå…ƒç´ 
        const trainDisplay = document.getElementById('trainDisplay');
        const trainPhaseDiv = document.getElementById('trainPhase');
        const answerWordDiv = document.getElementById('answerWord');
        const feedbackTextDiv = document.getElementById('feedbackText');
        const textInput = document.getElementById('textInput');
        const micStatusText = document.getElementById('micStatusText');

        // ç»Ÿè®¡å…ƒç´ 
        const wordCountDisplaySpan = document.getElementById('wordCountDisplay');
        const totalWordsStatSpan = document.getElementById('totalWordsStat');
        const correctWordsStatSpan = document.getElementById('correctWordsStat');
        const wrongWordsStatSpan = document.getElementById('wrongWordsStat');

        // å…¨å±€çŠ¶æ€
        let isTraining = false;
        let isPaused = false;
        let currentMode = 'mic'; // 'mic' æˆ– 'text'
        let speechSynth = window.speechSynthesis;
        let speechRecognition = null;
        let currentUtterance = null;
        let advanceTimer = null;
        
        // è®­ç»ƒæ•°æ®
        let allCustomWords = [];
        let challengeWords = [];
        let wrongWords = [];
        let currentWordIndex = 0;
        let currentChallengeWord = '';
        
        // ç»Ÿè®¡
        let totalChallenges = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let isMicPermissionGranted = false;

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            loadSavedWordList();
            loadSettings();
            updateWordCount();
            setupEventListeners();
            initSpeechRecognition();
            checkMicPermission();
            updatePauseButton();
            updateModeDisplay();
        }

        function loadSavedWordList() {
            const savedWords = localStorage.getItem('hearingTrainer_vocab');
            if (savedWords) {
                customWordListTextarea.value = savedWords;
            }
            updateWordCount();
        }

        function loadSettings() {
            const savedCount = localStorage.getItem('hearingTrainer_count') || '6';
            const savedSpeed = localStorage.getItem('hearingTrainer_speed') || '0.8';
            const savedRandomOrder = localStorage.getItem('hearingTrainer_randomOrder') !== 'false';
            const savedMode = localStorage.getItem('hearingTrainer_mode') || 'mic';

            trainCountInput.value = savedCount;
            speedRateSelect.value = savedSpeed;
            randomOrderCheckbox.checked = savedRandomOrder;
            setMode(savedMode);
        }

        function saveSettings() {
            localStorage.setItem('hearingTrainer_count', trainCountInput.value);
            localStorage.setItem('hearingTrainer_speed', speedRateSelect.value);
            localStorage.setItem('hearingTrainer_randomOrder', randomOrderCheckbox.checked);
            localStorage.setItem('hearingTrainer_mode', currentMode);
        }

        function updateWordCount() {
            const words = getWordArrayFromTextarea();
            wordCountDisplaySpan.textContent = words.length;
        }

        function getWordArrayFromTextarea() {
            return customWordListTextarea.value.trim().split('\n').filter(line => line.trim() !== '');
        }

        // ==================== æ¨¡å¼åˆ‡æ¢ ====================
        function setMode(mode) {
            currentMode = mode;
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            if (mode === 'mic') {
                micStatusText.textContent = "éº¦å…‹é£è·Ÿè¯»æ¨¡å¼";
                currentModeDisplay.textContent = "éº¦å…‹é£è·Ÿè¯»æ¨¡å¼";
                permissionGuide.classList.add('show');
                permissionInfoBox.classList.add('show');
                textInput.classList.remove('show');
            } else {
                micStatusText.textContent = "æ‰“å­—è¾“å…¥æ¨¡å¼";
                currentModeDisplay.textContent = "æ‰“å­—è¾“å…¥æ¨¡å¼";
                permissionGuide.classList.remove('show');
                permissionInfoBox.classList.remove('show');
                textInput.classList.add('show');
            }
            
            saveSettings();
            updateModeDisplay();
        }

        function updateModeDisplay() {
            if (currentMode === 'mic') {
                micStatusText.textContent = "éº¦å…‹é£è·Ÿè¯»æ¨¡å¼";
                currentModeDisplay.textContent = "éº¦å…‹é£è·Ÿè¯»æ¨¡å¼";
            } else {
                micStatusText.textContent = "æ‰“å­—è¾“å…¥æ¨¡å¼";
                currentModeDisplay.textContent = "æ‰“å­—è¾“å…¥æ¨¡å¼";
            }
        }

        // ==================== æš‚åœ/ç»§ç»­åŠŸèƒ½ ====================
        function togglePause() {
            if (!isTraining) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                // æš‚åœé€»è¾‘
                if (currentUtterance && speechSynth.speaking) {
                    speechSynth.pause();
                }
                if (speechRecognition) {
                    speechRecognition.stop();
                }
                if (advanceTimer) {
                    clearTimeout(advanceTimer);
                }
                
                updateTrainPhase("â¸ï¸ è®­ç»ƒå·²æš‚åœ", true);
                pauseBtn.innerHTML = 'â–¶ï¸ ç»§ç»­';
            } else {
                // ç»§ç»­é€»è¾‘
                if (currentUtterance && speechSynth.paused) {
                    speechSynth.resume();
                } else {
                    // å¦‚æœæ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªè¯
                    speakNextWord();
                }
                
                pauseBtn.innerHTML = 'â¸ï¸ æš‚åœ';
            }
            
            updatePauseButton();
        }

        function updatePauseButton() {
            if (isTraining) {
                pauseBtn.disabled = false;
                pauseBtn.innerHTML = isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
            } else {
                pauseBtn.disabled = true;
                pauseBtn.innerHTML = 'â¸ï¸ æš‚åœ';
            }
        }

        // ==================== éº¦å…‹é£æƒé™æ£€æŸ¥ ====================
        function checkMicPermission() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'microphone' })
                    .then(permissionStatus => {
                        isMicPermissionGranted = permissionStatus.state === 'granted';
                        permissionStatus.onchange = function() {
                            isMicPermissionGranted = this.state === 'granted';
                        };
                    })
                    .catch(() => {
                        isMicPermissionGranted = false;
                    });
            } else {
                isMicPermissionGranted = false;
            }
        }

        // ==================== è¯­éŸ³è¯†åˆ«åˆå§‹åŒ– ====================
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«");
                setMode('text');
                return;
            }
            
            speechRecognition = new SpeechRecognition();
            speechRecognition.lang = 'zh-CN';
            speechRecognition.interimResults = false;
            speechRecognition.maxAlternatives = 1;
            
            speechRecognition.onstart = function() {
                if (!isPaused) {
                    trainDisplay.classList.add('listening');
                }
            };
            
            speechRecognition.onend = function() {
                trainDisplay.classList.remove('listening');
                if (isTraining && currentMode === 'mic' && !isPaused) {
                    setTimeout(() => {
                        if (speechRecognition && isTraining && !isPaused) {
                            try {
                                speechRecognition.start();
                            } catch(e) {
                                console.log("é‡æ–°å¯åŠ¨è¯†åˆ«å¤±è´¥");
                            }
                        }
                    }, 500);
                }
            };
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim();
                if (transcript && !isPaused) {
                    processUserAnswer(transcript);
                }
            };
            
            speechRecognition.onerror = function(event) {
                console.log("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
                if (event.error === 'not-allowed') {
                    alert("éº¦å…‹é£è®¿é—®è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™ä½¿ç”¨éº¦å…‹é£ã€‚");
                    setMode('text');
                }
                trainDisplay.classList.remove('listening');
            };
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        function setupEventListeners() {
            startBtn.addEventListener('click', startTraining);
            stopBtn.addEventListener('click', stopTraining);
            pauseBtn.addEventListener('click', togglePause);
            saveBtn.addEventListener('click', saveWordList);
            textInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isPaused) submitAnswer();
            });
            
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    setMode(this.dataset.mode);
                });
            });
            
            customWordListTextarea.addEventListener('input', function() {
                updateWordCount();
                localStorage.setItem('hearingTrainer_vocab', this.value);
            });
            
            trainCountInput.addEventListener('change', saveSettings);
            speedRateSelect.addEventListener('change', saveSettings);
            randomOrderCheckbox.addEventListener('change', saveSettings);
            
            window.addEventListener('beforeunload', cleanup);
        }

        function cleanup() {
            if (isTraining && currentUtterance && speechSynth.speaking) {
                speechSynth.cancel();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
            if (advanceTimer) clearTimeout(advanceTimer);
        }

        // ==================== è®­ç»ƒå¼•æ“æ ¸å¿ƒ ====================
        function startTraining() {
            if (isTraining) return;
            
            allCustomWords = getWordArrayFromTextarea();
            if (allCustomWords.length === 0) {
                updateTrainPhase("âŒ è¯·å…ˆåœ¨å·¦ä¾§å½•å…¥ä¸€äº›è¯æ±‡ã€‚", true);
                return;
            }
            
            if (currentMode === 'mic') {
                if (!speechRecognition) {
                    updateTrainPhase("âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æ‰“å­—æ¨¡å¼ã€‚", true);
                    setMode('text');
                    return;
                }
            }
            
            const count = parseInt(trainCountInput.value);
            challengeWords = [...allCustomWords];
            if (randomOrderCheckbox.checked) {
                challengeWords = shuffleArray(challengeWords);
            }
            challengeWords = challengeWords.slice(0, Math.min(count, challengeWords.length));
            
            currentWordIndex = 0;
            wrongWords = [];
            totalChallenges = challengeWords.length;
            correctCount = 0;
            wrongCount = 0;
            isPaused = false;
            
            totalWordsStatSpan.textContent = totalChallenges;
            correctWordsStatSpan.textContent = '0';
            wrongWordsStatSpan.textContent = '0';
            
            isTraining = true;
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            pauseBtn.disabled = false;
            customWordListTextarea.readOnly = true;
            textInput.value = '';
            
            updateTrainPhase(`ğŸ¯ æŒ‘æˆ˜å¼€å§‹ï¼å…± ${totalChallenges} ä¸ªè¯`, false);
            updatePauseButton();
            setTimeout(() => speakNextWord(), 1500);
        }

        function speakNextWord() {
            if (!isTraining || isPaused || currentWordIndex >= challengeWords.length) {
                if (currentWordIndex >= challengeWords.length) finishTraining();
                return;
            }
            
            currentChallengeWord = challengeWords[currentWordIndex];
            answerWordDiv.textContent = '';
            feedbackTextDiv.textContent = '';
            trainDisplay.classList.remove('correct', 'wrong', 'listening');
            textInput.value = '';
            
            updateTrainPhase("ğŸ”Š æ­£åœ¨æœ—è¯»ï¼Œè¯·ä»”ç»†å¬...", false);
            
            const speed = parseFloat(speedRateSelect.value);
            currentUtterance = new SpeechSynthesisUtterance(currentChallengeWord);
            currentUtterance.lang = 'zh-CN';
            currentUtterance.rate = speed;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            currentUtterance.onend = function() {
                if (isPaused) return;
                
                if (currentMode === 'mic') {
                    updateTrainPhase("ğŸ¤ è¯·è·Ÿè¯»...", false);
                    if (speechRecognition && isTraining && !isPaused) {
                        try {
                            speechRecognition.start();
                        } catch(e) {
                            console.log("å¯åŠ¨è¯†åˆ«å¤±è´¥:", e);
                        }
                    }
                } else {
                    updateTrainPhase("âœï¸ è¯·è¾“å…¥æ‚¨å¬åˆ°çš„è¯", false);
                    textInput.focus();
                }
            };
            
            speechSynth.speak(currentUtterance);
        }

        function submitAnswer() {
            if (!isTraining || isPaused) return;
            
            if (currentMode === 'text') {
                const userAnswer = textInput.value.trim();
                if (!userAnswer) {
                    feedbackTextDiv.innerHTML = `<span class="feedback-wrong">âš ï¸ è¯·è¾“å…¥ç­”æ¡ˆ</span>`;
                    return;
                }
                processUserAnswer(userAnswer);
            }
        }

        function processUserAnswer(userAnswer) {
            if (!isTraining || isPaused) return;
            
            const isCorrect = isAnswerCorrect(userAnswer, currentChallengeWord);
            
            if (isCorrect) {
                correctCount++;
                correctWordsStatSpan.textContent = correctCount;
                feedbackTextDiv.innerHTML = `<span class="feedback-correct">âœ… æ­£ç¡®ï¼ï¼ˆç­”æ¡ˆï¼š${currentChallengeWord}ï¼‰</span>`;
                trainDisplay.classList.add('correct');
            } else {
                wrongCount++;
                wrongWordsStatSpan.textContent = wrongCount;
                feedbackTextDiv.innerHTML = `<span class="feedback-wrong">âŒ ä¸æ­£ç¡®ï¼ï¼ˆæ­£ç¡®ç­”æ¡ˆï¼š${currentChallengeWord}ï¼‰</span>`;
                trainDisplay.classList.add('wrong');
                if (!wrongWords.includes(currentChallengeWord)) {
                    wrongWords.push(currentChallengeWord);
                }
            }
            
            answerWordDiv.textContent = currentChallengeWord;
            
            advanceTimer = setTimeout(() => {
                currentWordIndex++;
                if (currentWordIndex < challengeWords.length) {
                    speakNextWord();
                } else {
                    finishTraining();
                }
            }, 2000);
        }

        function stopTraining() {
            isTraining = false;
            isPaused = false;
            
            if (currentUtterance && speechSynth.speaking) {
                speechSynth.cancel();
            }
            if (speechRecognition) {
                speechRecognition.stop();
            }
            if (advanceTimer) clearTimeout(advanceTimer);
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            pauseBtn.disabled = true;
            customWordListTextarea.readOnly = false;
            textInput.value = '';
            
            answerWordDiv.textContent = '';
            feedbackTextDiv.textContent = '';
            trainDisplay.classList.remove('correct', 'wrong', 'listening');
            
            updateTrainPhase("è®­ç»ƒå·²åœæ­¢", true);
            updatePauseButton();
            
            if (wrongWords.length > 0) {
                setTimeout(() => {
                    updateTrainPhase(`ğŸ“ æœ¬æ¬¡æœ‰ ${wrongWords.length} ä¸ªè¯éœ€è¦å¤ä¹ `, true);
                    feedbackTextDiv.textContent = wrongWords.join('ã€');
                    localStorage.setItem('hearingTrainer_wrongWords', JSON.stringify(wrongWords));
                }, 800);
            }
        }

        function finishTraining() {
            stopTraining();
            const accuracy = totalChallenges > 0 ? Math.round(correctCount/totalChallenges*100) : 0;
            updateTrainPhase(`ğŸ‰ æŒ‘æˆ˜å®Œæˆï¼æ­£ç¡®ç‡ï¼š${accuracy}%`, true);
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function isAnswerCorrect(userAnswer, correctAnswer) {
            const userClean = userAnswer.replace(/\s/g, '');
            const correctClean = correctAnswer.replace(/\s/g, '');
            
            if (userClean === correctClean) return true;
            
            if (Math.abs(userClean.length - correctClean.length) <= 2) {
                if (userClean.includes(correctClean) || correctClean.includes(userClean)) {
                    return true;
                }
            }
            
            return false;
        }

        function updateTrainPhase(message, isStatic = false) {
            trainPhaseDiv.textContent = message;
            trainPhaseDiv.style.color = isStatic ? '#636e72' : '#2d3436';
        }

        function saveWordList() {
            const wordList = customWordListTextarea.value.trim();
            if (!wordList) {
                feedbackTextDiv.textContent = "âŒ æ²¡æœ‰å†…å®¹å¯ä»¥ä¿å­˜";
                return;
            }
            localStorage.setItem('hearingTrainer_vocab', wordList);
            feedbackTextDiv.innerHTML = `<span class="feedback-correct">ğŸ’¾ å·²ä¿å­˜ ${getWordArrayFromTextarea().length} ä¸ªè¯æ±‡ï¼</span>`;
            setTimeout(() => {
                if (!isTraining) feedbackTextDiv.textContent = '';
            }, 2000);
        }

        // ==================== å¯åŠ¨åº”ç”¨ ====================
        window.addEventListener('load', init);
    </script>
</body>
</html>